---
- name: Ensure required packages are present
  become: true
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
    state: present
    cache_valid_time: 3600

- name: Normalize architecture to Debian package arch
  ansible.builtin.set_fact:
    ghostty_arch: >-
      {{
        (ansible_architecture == 'x86_64') | ternary('amd64',
        (ansible_architecture == 'aarch64') | ternary('arm64',
        ansible_architecture))
      }}

- name: Compute Ghostty SUFFIX
  ansible.builtin.set_fact:
    ghostty_suffix: "{{ _ghostty_suffix | trim }}"
  vars:
    os_id: "{{ ansible_distribution | lower }}"
    # /etc/os-release-like values via Ansible facts
    ubuntu_version_id: "{{ ansible_distribution_version }}"
    ubuntu_codename: "{{ ansible_distribution_release | lower }}"
    debian_codename: "{{ ansible_distribution_release | lower }}"
    _ghostty_suffix: >-
      {# Ubuntu-like #}
      {% if os_id in ['ubuntu','pop!_os','pop','tuxedo','kde neon','neon'] %}
        {% if ubuntu_version_id in ghostty_supported_ubuntu_versions %}
          {{ ghostty_arch }}_{{ ubuntu_version_id }}
        {% else %}
          unsupported
        {% endif %}

      {# Elementary often reports itself as Ubuntu-based; best-effort: treat as Ubuntu if version matches #}
      {% elif os_id in ['elementary'] %}
        {% if ubuntu_version_id in ghostty_supported_ubuntu_versions %}
          {{ ghostty_arch }}_{{ ubuntu_version_id }}
        {% else %}
          unsupported
        {% endif %}

      {# Debian #}
      {% elif os_id in ['debian'] %}
        {% if debian_codename in ghostty_supported_debian_codenames %}
          {{ ghostty_arch }}_{{ debian_codename }}
        {% else %}
          unsupported
        {% endif %}

      {# Kali -> Debian codename mapping by year from version like 2025.x #}
      {% elif os_id in ['kali'] %}
        {% set kali_year = (ubuntu_version_id.split('.')[0]) %}
        {% set mapped = ghostty_kali_year_to_debian.get(kali_year) %}
        {% if mapped %}
          {{ ghostty_arch }}_{{ mapped }}
        {% else %}
          unsupported
        {% endif %}

      {# Linux Mint / Zorin: either LMDE (debian) or map ubuntu codename to ubuntu version #}
      {% elif os_id in ['linux mint','linuxmint','zorin'] %}
        {# LMDE shows as debian-ish; Ansible often calls it Linux Mint but release is 'trixie' when LMDE tracks it #}
        {% if debian_codename in ghostty_supported_debian_codenames %}
          {{ ghostty_arch }}_{{ debian_codename }}
        {% else %}
          {% set mapped = ghostty_ubuntu_codename_to_version.get(ubuntu_codename) %}
          {% if mapped %}
            {{ ghostty_arch }}_{{ mapped }}
          {% else %}
            unsupported
          {% endif %}
        {% endif %}

      {# Other Ubuntu-based: best-effort use ubuntu_version_id #}
      {% else %}
        {% if ubuntu_version_id in ghostty_supported_ubuntu_versions %}
          {{ ghostty_arch }}_{{ ubuntu_version_id }}
        {% else %}
          unsupported
        {% endif %}
      {% endif %}

- name: Fail if OS/version is unsupported
  ansible.builtin.fail:
    msg: >-
      Ghostty installer role does not support:
      distro={{ ansible_distribution }} version={{ ansible_distribution_version }} release={{ ansible_distribution_release }}
      arch={{ ansible_architecture }} (normalized={{ ghostty_arch }}).
      Expected Ubuntu versions {{ ghostty_supported_ubuntu_versions | join(', ') }}
      or Debian codenames {{ ghostty_supported_debian_codenames | join(', ') }}.
  when: ghostty_suffix == "unsupported"

- name: Ensure temp download directory exists
  ansible.builtin.file:
    path: "{{ ghostty_tmp_dir }}"
    state: directory
    mode: "0755"

- name: Fetch latest release metadata from GitHub
  ansible.builtin.uri:
    url: "https://api.github.com/repos/{{ ghostty_repo }}/releases/{{ ghostty_release }}"
    method: GET
    headers:
      Accept: "application/vnd.github.v3+json"
    return_content: true
    body_format: json
  register: ghostty_release_meta
  retries: 6
  delay: 3
  until: ghostty_release_meta.status == 200

- name: Build regex pattern (escaped) for the asset
  ansible.builtin.set_fact:
    ghostty_asset_pattern: "^ghostty_.*_{{ ghostty_suffix | trim | regex_escape }}\\.deb$"

#- name: Debug suffix/pattern
#  ansible.builtin.debug:
#    msg:
#      suffix_raw: "{{ ghostty_suffix }}"
#      suffix_trimmed: "{{ ghostty_suffix | trim }}"
#      pattern: "{{ ghostty_asset_pattern }}"
#      available: "{{ ghostty_release_meta.json.assets | map(attribute='name') | list }}"
#      matched: >-
#        {{
#          ghostty_release_meta.json.assets
#          | selectattr('name', 'match', ghostty_asset_pattern)
#          | map(attribute='name')
#          | list
#        }}

- name: Pick matching .deb asset for this platform
  ansible.builtin.set_fact:
    ghostty_asset: >-
      {{
        ghostty_release_meta.json.assets
        | selectattr('name', 'match', ghostty_asset_pattern)
        | list
        | first
        | default({})
      }}

- name: Fail if no matching asset exists in the release
  ansible.builtin.fail:
    msg: >-
      No Ghostty .deb asset matched suffix {{ ghostty_suffix }} in GitHub release.
      Available assets: {{
        (ghostty_release_meta.json.assets | default([])) | map(attribute='name') | list
      }}
  when: ghostty_asset == {}

- name: Download Ghostty .deb
  ansible.builtin.get_url:
    url: "{{ ghostty_asset.browser_download_url }}"
    dest: "{{ ghostty_tmp_dir }}/{{ ghostty_asset.name }}"
    mode: "0644"
  register: ghostty_download

- name: Install Ghostty .deb
  become: true
  ansible.builtin.apt:
    deb: "{{ ghostty_tmp_dir }}/{{ ghostty_asset.name }}"
    state: present

- name: Remove downloaded .deb
  ansible.builtin.file:
    path: "{{ ghostty_tmp_dir }}/{{ ghostty_asset.name }}"
    state: absent

- name: Ensure Ghostty config directory exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.config/ghostty"
    state: directory
    mode: "0755"

- name: Symlink Ghostty config from role files
  ansible.builtin.file:
    src: "{{ role_path }}/files/config"
    dest: "{{ ansible_env.HOME }}/.config/ghostty/config"
    state: link
    force: true

